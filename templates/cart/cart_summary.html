{% extends '_base.html' %}
{% load static %}

{% block extend_head %}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"> 
{% endblock extend_head %}

{% block content %}

    <div class="my-5 py-5">
    <div class="container">
        <div class="row justify-content-center align-items-center">
            <div class="col-md-8 text-center mb-4">
                <h2 class="mb-5">Cart Summary</h2>

                <div class="row header-row mb-2"> <div class="col-2"><h6>Product Name</h6></div>
                    <div class="col-2"><h6>Shop Name</h6></div>
                    <div class="col-2"><h6>Price</h6></div>
                    <div class="col-6"><h6>Quantity</h6></div> 
                </div>
                

                {% for product in cart_products %}
                    <div class="product-details row"> 
                        <div class="col-2"><h6>{{ product.product.name }}</h6></div>
                        <div class="col-2"><h6>{{ product.shop.name }}</h6></div>
                        <div class="col-2"><h6>{{ product.platform_price }}</h6></div>
                        <div class="col-6 qty-adjust d-flex align-items-center">
                            <button class="btn btn-minus" data-product-id="{{ product.id }}"><i class="fa-solid fa-minus"></i></button>
                            <input type="text" class="qty-input form-control" data-product-id="{{ product.id }}" value="{{ product.quantity }}" readonly>  
                            <button class="btn btn-plus" data-product-id="{{ product.id }}"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                {% endfor %}

                <button id="update-cart-btn" class="btn btn-primary">Update Cart</button>

                
            </div>

        </div>
    </div>
    </div>

    <script>
        $(document).ready(function() {
            $('.btn-plus, .btn-minus').on('click', function(e) {
                const isPlusButton = $(this).hasClass('btn-plus');
                const productId = $(this).data('productId');
                const inputField = $(this).siblings('.qty-input');
                let newQuantity = parseInt(inputField.val());
        
                if (isPlusButton) {
                    newQuantity += 1;
                } else {
                    if (newQuantity > 1) {
                        newQuantity -= 1;
                    }
                }
        
                inputField.val(newQuantity);
            });
        
            $('#update-cart-btn').on('click', function() {
                const quantities = {}; 
        
                $('.qty-input').each(function() {
                    const productId = $(this).data('productId'); 
                    const quantity = parseInt($(this).val());
                    quantities[productId] = quantity;
                });
                console.log(JSON.stringify(quantities));
        
                $.ajax({
                    type: 'POST',
                    url: '{% url 'cart_update' %}',
                    data: {
                        quantities: JSON.stringify(quantities), 
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        action: 'post'
                    },
                    success: function(json) {
                        console.log('Cart updated successfully');
                    },
                    error: function(xhr, errmsg, err) {
                        console.error('Cart update failed:', err); 
                    }
                });
            });
        });        
    </script>

{% endblock content %}